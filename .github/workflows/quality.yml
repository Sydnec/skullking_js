name: ðŸ” Skull King Code Quality

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  schedule:
    - cron: '0 6 * * 1'  # Analyse hebdomadaire le lundi Ã  6h

permissions:
  actions: read
  contents: read
  security-events: write

env:
  NODE_VERSION: '18'

jobs:
  security:
    name: ðŸ›¡ï¸ Audit SÃ©curitÃ©
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ›¡ï¸ Backend security audit
        run: |
          cd backend
          npm ci
          npm audit --audit-level high
          
      - name: ðŸ›¡ï¸ Frontend security audit
        run: |
          cd frontend
          npm ci
          npm audit --audit-level high
          
      - name: ðŸ” Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          config: |
            name: "CodeQL Config"
            queries:
              - uses: security-and-quality
          
      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v3
        
      - name: ðŸ“Š Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

  lint:
    name: ðŸ” Analyse Statique
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ” Lint backend
        run: |
          cd backend
          npm ci
          npm run lint
          
      - name: ðŸ” Lint frontend
        run: |
          cd frontend
          npm ci
          npm run lint
          
      - name: ðŸŽ¨ Check TypeScript
        run: |
          cd frontend
          npx tsc --noEmit
          
      - name: ðŸ“ Check code formatting
        run: |
          cd backend && npx prettier --check . || true
          cd ../frontend && npx prettier --check . || true

  dependencies:
    name: ðŸ“¦ Analyse DÃ©pendances
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“Š Check outdated packages
        run: |
          echo "## ðŸ“¦ Backend Dependencies" > deps-report.md
          cd backend
          npm outdated --json > ../backend-deps.json || true
          
          echo "## ðŸ“¦ Frontend Dependencies" >> ../deps-report.md
          cd ../frontend
          npm outdated --json > ../frontend-deps.json || true
          
      - name: ðŸ” License compliance check
        run: |
          cd backend
          npx license-checker --json > ../backend-licenses.json || true
          cd ../frontend
          npx license-checker --json > ../frontend-licenses.json || true
          
      - name: ðŸ“¤ Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-analysis
          path: |
            *-deps.json
            *-licenses.json
            deps-report.md

  performance:
    name: âš¡ Analyse Performance
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ—ï¸ Build analysis
        run: |
          cd frontend
          npm ci
          npm run build
          
          # Analyse de la taille du bundle
          npx bundlephobia-cli package.json > ../bundle-analysis.txt || true
          
      - name: ðŸ“Š Bundle size analysis
        run: |
          cd frontend
          
          # Afficher la taille des assets
          echo "## ðŸ“¦ Taille du Bundle" > ../performance-report.md
          if [ -d ".next/static" ]; then
            echo "### JavaScript:" >> ../performance-report.md
            find .next/static -name "*.js" -exec ls -lh {} \; | head -10 >> ../performance-report.md
            echo "### CSS:" >> ../performance-report.md
            find .next/static -name "*.css" -exec ls -lh {} \; >> ../performance-report.md
          fi
          
      - name: ðŸ“¤ Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-analysis
          path: |
            bundle-analysis.txt
            performance-report.md

  complexity:
    name: ðŸ§® ComplexitÃ© du Code
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ðŸ“Š Install analysis tools
        run: |
          npm install -g plato jshint
          
      - name: ðŸ§® Analyze backend complexity
        run: |
          cd backend
          plato -r -d ../backend-complexity src/ || true
          
      - name: ðŸ§® Analyze frontend complexity
        run: |
          cd frontend
          plato -r -d ../frontend-complexity src/ || true
          
      - name: ðŸ“ Generate metrics report
        run: |
          echo "## ðŸ§® Analyse de ComplexitÃ©" > complexity-report.md
          echo "" >> complexity-report.md
          
          # Compter les lignes de code
          echo "### ðŸ“Š Statistiques GÃ©nÃ©rales" >> complexity-report.md
          echo "- Backend: $(find backend/src -name "*.js" | xargs wc -l | tail -1 | awk '{print $1}') lignes" >> complexity-report.md
          echo "- Frontend: $(find frontend/src -name "*.{js,ts,tsx}" | xargs wc -l | tail -1 | awk '{print $1}') lignes" >> complexity-report.md
          
          # Compter les fichiers
          echo "- Fichiers backend: $(find backend/src -name "*.js" | wc -l)" >> complexity-report.md
          echo "- Fichiers frontend: $(find frontend/src -name "*.{js,ts,tsx}" | wc -l)" >> complexity-report.md
          
      - name: ðŸ“¤ Upload complexity reports
        uses: actions/upload-artifact@v4
        with:
          name: complexity-analysis
          path: |
            *-complexity/
            complexity-report.md

  documentation:
    name: ðŸ“š QualitÃ© Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸ“ Check documentation completeness
        run: |
          echo "## ðŸ“š Analyse Documentation" > doc-report.md
          echo "" >> doc-report.md
          
          # VÃ©rifier les fichiers README
          echo "### ðŸ“„ Fichiers de Documentation" >> doc-report.md
          [ -f "README.md" ] && echo "- âœ… README.md principal" >> doc-report.md || echo "- âŒ README.md principal manquant" >> doc-report.md
          [ -f "backend/README.md" ] && echo "- âœ… README.md backend" >> doc-report.md || echo "- âš ï¸ README.md backend manquant" >> doc-report.md
          [ -f "frontend/README.md" ] && echo "- âœ… README.md frontend" >> doc-report.md || echo "- âš ï¸ README.md frontend manquant" >> doc-report.md
          [ -f "CONTRIBUTING.md" ] && echo "- âœ… CONTRIBUTING.md" >> doc-report.md || echo "- âš ï¸ CONTRIBUTING.md manquant" >> doc-report.md
          [ -f "docs/API.md" ] && echo "- âœ… Documentation API" >> doc-report.md || echo "- âš ï¸ Documentation API manquante" >> doc-report.md
          
          # VÃ©rifier la longueur des README
          echo "" >> doc-report.md
          echo "### ðŸ“ Taille des Documentations" >> doc-report.md
          [ -f "README.md" ] && echo "- README principal: $(wc -l < README.md) lignes" >> doc-report.md
          [ -f "backend/README.md" ] && echo "- README backend: $(wc -l < backend/README.md) lignes" >> doc-report.md
          [ -f "frontend/README.md" ] && echo "- README frontend: $(wc -l < frontend/README.md) lignes" >> doc-report.md
          
      - name: ðŸ” Check JSDoc coverage
        run: |
          cd backend
          npm ci
          
          # Analyser la couverture JSDoc
          echo "" >> ../doc-report.md
          echo "### ðŸ“– Couverture JSDoc" >> ../doc-report.md
          
          # Compter les fonctions documentÃ©es vs non documentÃ©es
          TOTAL_FUNCTIONS=$(grep -r "function\|=>" src/ --include="*.js" | wc -l)
          DOCUMENTED_FUNCTIONS=$(grep -r "/\*\*" src/ --include="*.js" | wc -l)
          
          echo "- Fonctions totales: $TOTAL_FUNCTIONS" >> ../doc-report.md
          echo "- Fonctions documentÃ©es: $DOCUMENTED_FUNCTIONS" >> ../doc-report.md
          
          if [ $TOTAL_FUNCTIONS -gt 0 ]; then
            COVERAGE=$((DOCUMENTED_FUNCTIONS * 100 / TOTAL_FUNCTIONS))
            echo "- Couverture documentation: ${COVERAGE}%" >> ../doc-report.md
          fi
          
      - name: ðŸ“¤ Upload documentation report
        uses: actions/upload-artifact@v4
        with:
          name: documentation-analysis
          path: doc-report.md

  summary:
    name: ðŸ“‹ RÃ©sumÃ© QualitÃ©
    runs-on: ubuntu-latest
    needs: [security, lint, dependencies, performance, complexity, documentation]
    if: always()
    
    steps:
      - name: ðŸ“‹ Generate quality summary
        run: |
          echo "# ðŸ” Rapport QualitÃ© Skull King" > quality-summary.md
          echo "" >> quality-summary.md
          echo "## ðŸ“Š Statuts des Analyses" >> quality-summary.md
          echo "- ðŸ›¡ï¸ SÃ©curitÃ©: ${{ needs.security.result }}" >> quality-summary.md
          echo "- ðŸ” Lint: ${{ needs.lint.result }}" >> quality-summary.md
          echo "- ðŸ“¦ DÃ©pendances: ${{ needs.dependencies.result }}" >> quality-summary.md
          echo "- âš¡ Performance: ${{ needs.performance.result }}" >> quality-summary.md
          echo "- ðŸ§® ComplexitÃ©: ${{ needs.complexity.result }}" >> quality-summary.md
          echo "- ðŸ“š Documentation: ${{ needs.documentation.result }}" >> quality-summary.md
          echo "" >> quality-summary.md
          echo "## ðŸŽ¯ Actions RecommandÃ©es" >> quality-summary.md
          echo "1. Consulter les rapports d'artefacts pour les dÃ©tails" >> quality-summary.md
          echo "2. Corriger les problÃ¨mes de sÃ©curitÃ© identifiÃ©s" >> quality-summary.md
          echo "3. Mettre Ã  jour les dÃ©pendances obsolÃ¨tes" >> quality-summary.md
          echo "4. AmÃ©liorer la documentation manquante" >> quality-summary.md
          
      - name: ðŸ“¤ Upload quality summary
        uses: actions/upload-artifact@v4
        with:
          name: quality-summary
          path: quality-summary.md
