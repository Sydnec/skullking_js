name: ğŸ§ª Skull King Tests

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  schedule:
    - cron: '0 3 * * *'  # Tests quotidiens Ã  2h du matin

env:
  NODE_VERSION: '18'

jobs:
  test-backend:
    name: ğŸ”§ Tests Backend
    runs-on: ubuntu-latest
    
    env:
      DATABASE_URL: "file:./test.db"
    
    services:
      sqlite:
        image: nouchka/sqlite3:latest
        
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
          
      - name: ğŸ“‹ Install dependencies
        run: |
          cd backend
          npm ci
          
      - name: ğŸ—„ï¸ Setup test database
        run: |
          cd backend
          npx prisma generate
          npx prisma db push --force-reset
          
      - name: ğŸ§ª Run unit tests
        run: |
          cd backend
          npm test || echo "âš ï¸ Pas de tests configurÃ©s pour le backend"
          
      - name: ğŸ“Š Run coverage
        run: |
          cd backend
          npm run test:coverage || echo "âš ï¸ Pas de coverage configurÃ© pour le backend"
          
      - name: ğŸ” Lint backend code
        run: |
          cd backend
          npm run lint || true
          
      - name: ğŸ›¡ï¸ Security audit
        run: |
          cd backend
          npm audit --audit-level moderate || true

  test-frontend:
    name: ğŸ¨ Tests Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          
      - name: ğŸ“‹ Install dependencies
        run: |
          cd frontend
          npm ci
          
      - name: ğŸ§ª Run frontend tests
        run: |
          cd frontend
          npm test || echo "âš ï¸ Pas de tests configurÃ©s pour le frontend"
          
      - name: ğŸ—ï¸ Test build
        run: |
          cd frontend
          npm run build
          
      - name: ğŸ” Lint frontend code
        run: |
          cd frontend
          npm run lint || true
          
      - name: ğŸ¨ Check TypeScript
        run: |
          cd frontend
          npx tsc --noEmit
          
      - name: ğŸ›¡ï¸ Security audit
        run: |
          cd frontend
          npm audit --audit-level moderate || true

  test-integration:
    name: ğŸ”— Tests IntÃ©gration
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]
    
    env:
      DATABASE_URL: "file:./test.db"
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“‹ Install dependencies
        run: |
          cd backend && npm ci
          cd ../frontend && npm ci
          
      - name: ğŸ—„ï¸ Setup database
        run: |
          cd backend
          npx prisma generate
          npx prisma db push --force-reset
          
      - name: ğŸš€ Start backend
        run: |
          cd backend
          npm start &
          sleep 10
          
      - name: ğŸ—ï¸ Build frontend
        run: |
          cd frontend
          npm run build
          
      - name: ğŸŒ Start frontend
        run: |
          cd frontend
          npm start &
          sleep 10
          
      - name: ğŸ§ª Health checks
        run: |
          # Test backend API
          curl -f http://localhost:3001/health || exit 1
          
          # Test frontend
          curl -f http://localhost:3000 || exit 1
          
      - name: ğŸ§ª API integration tests
        run: |
          # Test crÃ©ation de partie
          curl -X POST http://localhost:3001/api/games \
            -H "Content-Type: application/json" \
            -d '{"name":"Test Game","maxPlayers":4}' || true
            
  test-e2e:
    name: ğŸ® Tests E2E
    runs-on: ubuntu-latest
    needs: [test-integration]
    
    env:
      DATABASE_URL: "file:./test.db"
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸŒ Install Playwright
        run: |
          cd frontend
          npm ci
          npx playwright install
          
      - name: ğŸ—„ï¸ Setup database
        run: |
          cd backend
          npm ci
          npx prisma generate
          npx prisma db push --force-reset
          
      - name: ğŸš€ Start services
        run: |
          cd backend && npm start &
          cd frontend && npm run build && npm start &
          sleep 15
          
      - name: ğŸ® Run E2E tests
        run: |
          cd frontend
          npx playwright test || true
          
      - name: ğŸ“¸ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

  test-performance:
    name: âš¡ Tests Performance
    runs-on: ubuntu-latest
    needs: [test-backend]
    
    env:
      DATABASE_URL: "file:./test.db"
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“‹ Install dependencies
        run: |
          cd backend && npm ci
          npm install -g autocannon
          
      - name: ğŸ—„ï¸ Setup database
        run: |
          cd backend
          npx prisma generate
          npx prisma db push --force-reset
          
      - name: ğŸš€ Start backend
        run: |
          cd backend
          npm start &
          sleep 10
          
      - name: âš¡ Performance tests
        run: |
          # Test health endpoint
          autocannon -c 10 -d 10 http://localhost:3001/health
          
          # Test API endpoint
          autocannon -c 5 -d 10 http://localhost:3001/api/games

  report:
    name: ğŸ“Š Rapport de Tests
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend, test-integration, test-e2e, test-performance]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate test report
        run: |
          echo "## ğŸ§ª Rapport de Tests Skull King" > test-report.md
          echo "" >> test-report.md
          echo "### ğŸ“ˆ Statuts des Jobs" >> test-report.md
          echo "- Backend: ${{ needs.test-backend.result }}" >> test-report.md
          echo "- Frontend: ${{ needs.test-frontend.result }}" >> test-report.md
          echo "- IntÃ©gration: ${{ needs.test-integration.result }}" >> test-report.md
          echo "- E2E: ${{ needs.test-e2e.result }}" >> test-report.md
          echo "- Performance: ${{ needs.test-performance.result }}" >> test-report.md
          
      - name: ğŸ“¤ Upload report
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.md
