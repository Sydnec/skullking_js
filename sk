#!/bin/bash

# üè¥‚Äç‚ò†Ô∏è Skull King - Script de gestion unifi√©
# Usage: sk [command]

# Auto-d√©tection du r√©pertoire du projet
# Si le script est dans /usr/local/bin, on utilise le r√©pertoire courant
# Sinon, on utilise le r√©pertoire du script
if [[ "${BASH_SOURCE[0]}" == "/usr/local/bin/sk" ]]; then
    PROJECT_DIR="$(pwd)"
else
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    PROJECT_DIR="$SCRIPT_DIR"
fi

BACKEND_DIR="$PROJECT_DIR/backend"
FRONTEND_DIR="$PROJECT_DIR/frontend"
LOG_DIR="$BACKEND_DIR/logs"

# Validation du r√©pertoire de projet
validate_project_directory() {
    if [[ ! -d "$BACKEND_DIR" ]] || [[ ! -d "$FRONTEND_DIR" ]]; then
        print_error "Ce r√©pertoire ne semble pas √™tre un projet Skull King valide."
        print_error "R√©pertoires attendus :"
        print_error "  - Backend: $BACKEND_DIR"
        print_error "  - Frontend: $FRONTEND_DIR"
        print_error ""
        print_error "Assurez-vous d'√™tre dans le r√©pertoire racine du projet ou que les r√©pertoires existent."
        exit 1
    fi
}

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

print_section() {
    echo -e "${CYAN}üìä $1${NC}"
    echo "----------------------------"
}

print_step() {
    echo -e "${GREEN}[√âTAPE]${NC} $1"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}‚ö†Ô∏è  $1${NC}"
}

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

# Fonction pour v√©rifier si l'application est en ligne
check_app_status() {
    if pm2 list 2>/dev/null | grep -q "skullking-backend.*online"; then
        return 0
    else
        return 1
    fi
}

# Fonction de monitoring compl√®te
monitor_function() {
    clear
    echo -e "${PURPLE}üè¥‚Äç‚ò†Ô∏è SKULL KING - MONITORING${NC}"
    echo "================================="
    echo ""
    
    # 1. Statut PM2
    print_section "Statut PM2"
    if pm2 list 2>/dev/null | grep -q "skullking-backend"; then
        pm2 list
        echo ""
        if check_app_status; then
            print_success "Backend Skull King en ligne"
        else
            print_error "Backend Skull King hors ligne"
        fi
    else
        print_error "Aucun processus PM2 trouv√©"
    fi
    echo ""

    # 2. Test de l'API
    print_section "Test de l'API"
    if curl -s http://localhost:3001/health >/dev/null 2>&1; then
        print_success "API accessible"
        echo "R√©ponse: $(curl -s http://localhost:3001/health)"
    else
        print_error "API non accessible"
    fi
    echo ""

    # 3. Ressources syst√®me
    print_section "Ressources syst√®me"
    echo "üíæ M√©moire: $(free -h | awk '/^Mem:/ {printf "Utilis√©e: %s/%s (%.2f%%)", $3, $2, ($3/$2)*100}')"
    echo "üî• CPU: $(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | sed 's/%us,//')% utilis√©"
    echo "üíø Disque: $(df -h / | awk 'NR==2 {printf "Utilis√©: %s/%s (%s)", $3, $2, $5}')"
    echo ""

    # 4. Connectivit√© r√©seau
    print_section "Connectivit√© r√©seau"
    echo "üåê IP locale: $(hostname -I | awk '{print $1}' 2>/dev/null || ipconfig getifaddr en0 2>/dev/null || echo "Non disponible")"
    if ss -tuln 2>/dev/null | grep -q ":3001 " || netstat -an 2>/dev/null | grep -q ":3001.*LISTEN"; then
        print_success "Port 3001 (Backend) ouvert et en √©coute"
    else
        print_error "Port 3001 (Backend) non accessible"
    fi
    echo ""

    # 5. Logs r√©cents
    print_section "Logs r√©cents (derni√®res 5 lignes)"
    pm2 logs skullking-backend --lines 5 --nostream 2>/dev/null || echo "Aucun log disponible"
    echo ""

    # 6. Informations de d√©ploiement
    print_section "Informations de d√©ploiement"
    if [ -f "$FRONTEND_DIR/.next/BUILD_ID" ]; then
        echo "üìÖ Derni√®re mise √† jour du build frontend: $(stat -c %y "$FRONTEND_DIR/.next/BUILD_ID" 2>/dev/null || stat -f %Sm "$FRONTEND_DIR/.next/BUILD_ID" 2>/dev/null || echo "Non disponible")"
    fi
    echo "üìÅ R√©pertoire projet: $PROJECT_DIR"
    echo "üìÅ Backend: $BACKEND_DIR"
    echo "üìÅ Frontend: $FRONTEND_DIR"
    echo "üë§ Utilisateur: $(whoami)"
    echo "üñ•Ô∏è  Hostname: $(hostname)"
    echo ""
    echo "üîÑ Pour actualiser: sk monitor"
    echo "üìä Pour PM2 monitoring: pm2 monit"
    echo "üìã Pour red√©marrer: sk restart"
}

# Fonction de mise √† jour
update_function() {
    cd "$PROJECT_DIR" || {
        print_error "Impossible d'acc√©der au r√©pertoire $PROJECT_DIR"
        exit 1
    }

    print_step "üîÑ Mise √† jour Skull King..."
    
    # Sauvegarde des logs
    print_step "Sauvegarde des logs actuels..."
    if [ -f "$LOG_DIR/combined.log" ]; then
        cp "$LOG_DIR/combined.log" "$LOG_DIR/combined.log.backup.$(date +%Y%m%d_%H%M%S)"
    fi

    # V√©rifier et arr√™ter PM2 si n√©cessaire
    print_step "üìã V√©rification du statut PM2..."
    if pm2 describe skullking-backend &> /dev/null; then
        print_step "‚úÖ Processus PM2 'skullking-backend' trouv√©"
        print_step "Arr√™t temporaire de l'application..."
        pm2 stop skullking-backend
    else
        print_warning "‚ö†Ô∏è Processus PM2 'skullking-backend' non trouv√©"
    fi

    # Sauvegarde de la base de donn√©es
    print_step "Sauvegarde de la base de donn√©es..."
    if [ -f "$BACKEND_DIR/prisma/dev.db" ]; then
        cp "$BACKEND_DIR/prisma/dev.db" "$BACKEND_DIR/prisma/dev.db.backup.$(date +%Y%m%d_%H%M%S)"
    fi

    # Git pull
    print_step "R√©cup√©ration des derni√®res modifications..."
    git pull origin main || print_warning "Impossible de faire git pull"

    # Installation des d√©pendances backend
    print_step "Installation des d√©pendances backend..."
    cd "$BACKEND_DIR"
    npm i

    # Retour au backend pour Prisma
    cd "$BACKEND_DIR"

    # G√©n√©ration Prisma
    print_step "G√©n√©ration du client Prisma..."
    npx prisma generate

    # Migration de la base de donn√©es
    print_step "Migration de la base de donn√©es..."
    NODE_ENV=production npx prisma db push

    # Red√©marrage
    print_step "Red√©marrage de l'application..."
    pm2 restart skullking-backend || pm2 start ecosystem.config.js --env production
    pm2 save

    # V√©rification finale
    sleep 5
    if check_app_status; then
        print_success "üéâ Mise √† jour termin√©e avec succ√®s!"
        print_success "Le backend est en ligne sur http://localhost:3001"
        print_success "Le frontend peut √™tre d√©ploy√© s√©par√©ment"
    else
        print_error "‚ùå Probl√®me lors de la mise √† jour"
        echo "V√©rifiez les logs avec: sk logs"
    fi
}

case "$1" in
    dev)
        validate_project_directory
        echo "üöÄ Lancement du mode d√©veloppement..."
        echo "Backend sur http://localhost:3001"
        echo "Frontend sur http://localhost:3000"
        echo ""
        print_step "D√©marrage du backend..."
        cd "$BACKEND_DIR"
        npm run dev &
        BACKEND_PID=$!
        
        print_step "D√©marrage du frontend..."
        cd "$FRONTEND_DIR"
        npm run dev &
        FRONTEND_PID=$!
        
        echo ""
        print_success "D√©veloppement d√©marr√©!"
        echo "Appuyez sur Ctrl+C pour arr√™ter les deux serveurs"
        
        # Attendre l'interruption et tuer les processus
        trap 'echo ""; print_step "Arr√™t des serveurs..."; kill $BACKEND_PID $FRONTEND_PID 2>/dev/null; print_success "Serveurs arr√™t√©s"; exit 0' INT
        wait
        ;;
    build)
        validate_project_directory
        echo "üèóÔ∏è Construction du frontend..."
        cd "$FRONTEND_DIR"
        print_step "Installation des d√©pendances..."
        npm i
        print_step "Build en cours..."
        npm run build
        if [ $? -eq 0 ]; then
            print_success "Frontend build√© avec succ√®s!"
            print_success "Pr√™t pour le d√©ploiement"
        else
            print_error "Erreur lors du build"
        fi
        ;;
    start)
        validate_project_directory
        echo "üöÄ D√©marrage de Skull King Backend..."
        cd "$BACKEND_DIR"
        pm2 start ecosystem.config.js --env production 2>/dev/null || {
            print_warning "Processus d√©j√† en cours, tentative de red√©marrage..."
            pm2 restart skullking-backend
        }
        pm2 save
        sleep 2
        if check_app_status; then
            print_success "Backend Skull King d√©marr√© avec succ√®s"
            print_success "Backend accessible sur http://localhost:3001"
        else
            print_error "√âchec du d√©marrage"
        fi
        ;;
    stop)
        echo "üõë Arr√™t de Skull King Backend..."
        pm2 stop skullking-backend 2>/dev/null || print_warning "Application d√©j√† arr√™t√©e"
        print_success "Backend Skull King arr√™t√©"
        ;;
    restart)
        echo "üîÑ Red√©marrage de Skull King Backend..."
        cd "$BACKEND_DIR"
        pm2 restart skullking-backend 2>/dev/null || {
            print_warning "Processus non trouv√©, d√©marrage..."
            pm2 start ecosystem.config.js --env production
        }
        pm2 save
        sleep 2
        if check_app_status; then
            print_success "Backend Skull King red√©marr√© avec succ√®s"
        else
            print_error "√âchec du red√©marrage"
        fi
        ;;
    status)
        if check_app_status; then
            print_success "Backend Skull King en ligne"
        else
            print_error "Backend Skull King hors ligne"
        fi
        ;;
    logs)
        echo "üìã Logs du Backend Skull King en temps r√©el (Ctrl+C pour arr√™ter):"
        echo "=========================================================="
        pm2 logs skullking-backend 2>/dev/null || print_error "Impossible d'acc√©der aux logs"
        ;;
    monitor)
        monitor_function
        ;;
    update)
        update_function
        ;;
    deploy)
        echo "üöÄ D√©ploiement backend..."
        cd "$PROJECT_DIR"
        
        # V√©rification et cr√©ation du fichier .env backend
        print_step "V√©rification de la configuration d'environnement backend..."
        cd "$BACKEND_DIR"
        if [ ! -f ".env" ]; then
            if [ -f ".env.example" ]; then
                print_step "Copie de .env.example vers .env..."
                cp .env.example .env
                print_success "Fichier .env cr√©√© √† partir de .env.example"
            else
                print_warning "Ni .env ni .env.example trouv√©s dans le backend"
            fi
        else
            print_success "Fichier .env d√©j√† pr√©sent dans le backend"
        fi
        
        # Arr√™t de l'application
        print_step "Arr√™t de l'application si elle est en cours d'ex√©cution..."
        pm2 stop skullking-backend 2>/dev/null || echo "Backend pas encore d√©marr√©"

        # Installation des d√©pendances backend
        print_step "Installation des d√©pendances backend..."
        cd "$BACKEND_DIR"
        npm i

        # G√©n√©ration du client Prisma
        print_step "G√©n√©ration du client Prisma..."
        npx prisma generate

        # Initialisation de la base de donn√©es
        print_step "Initialisation de la base de donn√©es de production..."
        NODE_ENV=production npx prisma db push

        # D√©marrage du backend avec PM2
        print_step "D√©marrage du backend avec PM2..."
        cd "$BACKEND_DIR"
        pm2 start ecosystem.config.js --env production

        # Sauvegarde de la configuration PM2
        print_step "Sauvegarde de la configuration PM2..."
        pm2 save

        # V√©rification finale
        sleep 5
        if check_app_status; then
            print_success "üéâ D√©ploiement backend termin√© avec succ√®s!"
            print_success "Backend accessible sur http://localhost:3001"
            print_success "Le frontend peut √™tre d√©ploy√© s√©par√©ment"
        else
            print_error "‚ùå Probl√®me lors du d√©ploiement"
        fi
        ;;
    deploy-full)
        echo "üöÄ D√©ploiement complet (backend + frontend)..."
        cd "$PROJECT_DIR"
        
        # V√©rification et cr√©ation du fichier .env backend
        print_step "V√©rification de la configuration d'environnement backend..."
        cd "$BACKEND_DIR"
        if [ ! -f ".env" ]; then
            if [ -f ".env.example" ]; then
                print_step "Copie de .env.example vers .env..."
                cp .env.example .env
                print_success "Fichier .env cr√©√© √† partir de .env.example"
            else
                print_warning "Ni .env ni .env.example trouv√©s dans le backend"
            fi
        else
            print_success "Fichier .env d√©j√† pr√©sent dans le backend"
        fi
        
        # V√©rification et cr√©ation du fichier .env frontend
        print_step "V√©rification de la configuration d'environnement frontend..."
        cd "$FRONTEND_DIR"
        if [ ! -f ".env.local" ]; then
            if [ -f ".env.example" ]; then
                print_step "Copie de .env.example vers .env.local..."
                cp .env.example .env.local
                print_success "Fichier .env.local cr√©√© √† partir de .env.example"
            else
                print_warning "Ni .env.local ni .env.example trouv√©s dans le frontend"
            fi
        else
            print_success "Fichier .env.local d√©j√† pr√©sent dans le frontend"
        fi
        
        # Arr√™t de l'application
        print_step "Arr√™t de l'application si elle est en cours d'ex√©cution..."
        pm2 stop skullking-backend 2>/dev/null || echo "Backend pas encore d√©marr√©"

        # Installation des d√©pendances backend
        print_step "Installation des d√©pendances backend..."
        cd "$BACKEND_DIR"
        npm i

        # G√©n√©ration du client Prisma
        print_step "G√©n√©ration du client Prisma..."
        npx prisma generate

        # Initialisation de la base de donn√©es
        print_step "Initialisation de la base de donn√©es de production..."
        NODE_ENV=production npx prisma db push

        # Installation des d√©pendances frontend
        print_step "Installation des d√©pendances frontend..."
        cd "$FRONTEND_DIR"
        npm i

        # Build du frontend
        print_step "Construction du frontend..."
        npm run build

        # D√©marrage du backend avec PM2
        print_step "D√©marrage du backend avec PM2..."
        cd "$BACKEND_DIR"
        pm2 start ecosystem.config.js --env production

        # Sauvegarde de la configuration PM2
        print_step "Sauvegarde de la configuration PM2..."
        pm2 save

        # V√©rification finale
        sleep 5
        if check_app_status; then
            print_success "üéâ D√©ploiement complet termin√© avec succ√®s!"
            print_success "Backend accessible sur http://localhost:3001"
            print_success "Frontend build√© et pr√™t √† √™tre d√©ploy√©"
        else
            print_error "‚ùå Probl√®me lors du d√©ploiement"
        fi
        ;;
    api)
        echo "üè• V√©rification de la sant√© de l'application..."
        if curl -s http://localhost:3001/health >/dev/null 2>&1; then
            print_success "API accessible"
            echo "R√©ponse: $(curl -s http://localhost:3001/health)"
        else
            print_error "API non accessible"
        fi
        ;;
    reset)
        # V√©rifier si l'option --y ou -y est pr√©sente
        auto_confirm=false
        if [[ "$2" == "--y" ]] || [[ "$2" == "-y" ]]; then
            auto_confirm=true
        fi
        
        echo "üîÑ R√©initialisation compl√®te du projet..."
        echo ""
        echo -e "${YELLOW}‚ö†Ô∏è  ATTENTION: Cette action va supprimer toutes les donn√©es!${NC}"
        echo -e "${YELLOW}‚ö†Ô∏è  Les utilisateurs, salles de jeu et parties seront perdues!${NC}"
        echo ""
        
        if [ "$auto_confirm" = true ]; then
            echo "Mode automatique activ√© (--y), confirmation ignor√©e"
            confirmation="o"
        else
            echo -n "√ätes-vous s√ªr de vouloir continuer? (O/n): "
            read -n 1 confirmation
            echo ""
        fi
        
        if [[ "$confirmation" =~ ^[Oo]$ ]] || [ -z "$confirmation" ]; then
            cd "$PROJECT_DIR" || {
                print_error "Impossible d'acc√©der au r√©pertoire $PROJECT_DIR"
                exit 1
            }

            # Suppression des logs
            print_step "Suppression des logs..."
            if [ -d "$LOG_DIR" ]; then
                rm -rf "$LOG_DIR"
                mkdir -p "$LOG_DIR"
                touch "$LOG_DIR/combined.log"
                touch "$LOG_DIR/error.log"
                touch "$LOG_DIR/out.log"
                print_success "Logs supprim√©s et r√©pertoire recr√©√©"
            else
                print_warning "R√©pertoire de logs non trouv√©, cr√©ation d'un nouveau"
                mkdir -p "$LOG_DIR"
            fi

            # Suppression de la base de donn√©es
            print_step "Suppression de la base de donn√©es..."
            if [ -f "$BACKEND_DIR/prisma/dev.db" ]; then
                rm -f "$BACKEND_DIR/prisma/dev.db"
                print_success "Base de donn√©es supprim√©e"
            fi

            # Arr√™t et suppression du processus PM2
            print_step "Arr√™t du processus PM2..."
            pm2 stop skullking-backend 2>/dev/null || echo "Processus d√©j√† arr√™t√©"
            pm2 delete skullking-backend 2>/dev/null || echo "Processus non trouv√©"

            # R√©initialisation de la base de donn√©es
            print_step "R√©initialisation de la base de donn√©es..."
            cd "$BACKEND_DIR"
            npx prisma db push --force-reset

            # Red√©marrage
            print_step "Red√©marrage de l'application..."
            pm2 start ecosystem.config.js --env production
            pm2 save
            
            sleep 2
            if check_app_status; then
                print_success "Projet r√©initialis√© et pr√™t √† utiliser"
                print_success "Backend accessible sur http://localhost:3001"
            else
                print_error "Erreur lors de la r√©initialisation"
            fi
        else
            print_warning "R√©initialisation annul√©e"
        fi
        ;;
    *)
        echo -e "${PURPLE}üè¥‚Äç‚ò†Ô∏è SKULL KING - Script de gestion unifi√©${NC}"
        echo "============================================="
        echo ""
        echo "Usage: sk [commande]"
        echo ""
        echo "Commandes disponibles:"
        echo ""
        echo "  start         - D√©marre le backend"
        echo "  stop          - Arr√™te le backend"
        echo "  restart       - Red√©marre le backend"
        echo "  status        - Affiche le statut du backend"
        echo "  logs          - Affiche les logs PM2 du backend en temps r√©el"
        echo "  monitor       - Monitoring complet avec ressources syst√®me"
        echo "  deploy        - D√©ploiement backend uniquement (recommand√©)"
        echo "  deploy-full   - D√©ploiement backend + build frontend"
        echo "  update        - Mise √† jour du backend"
        echo "  api           - V√©rifie la sant√© de l'API backend"
        echo "  dev           - Lance le d√©veloppement (backend + frontend)"
        echo "  build         - Build le frontend uniquement"
        echo "  reset         - R√©initialise compl√®tement le projet (‚ö†Ô∏è SUPPRIME TOUTES LES DONN√âES)"
        echo "                  Options: --y ou -y pour confirmer automatiquement"
        echo ""
        echo "Architecture:"
        echo "  üìÅ Backend : Port 3001 (API + Socket.IO)"
        echo "  üìÅ Frontend: Port 3000 (Next.js - dev) ou d√©ploy√© s√©par√©ment"
        echo ""
        exit 1
        ;;
esac
